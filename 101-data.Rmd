---
title: "101-data"
output: html_document
date: "2024-03-21"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```

```{r}
library(tidyverse)
```

## Received data on 03212024

2024-03-16	DTSA884	bcl2fastq2	NOVASEQX25B	NovaSeqX 25B: 300 (PE150)    

there are two lanes, putting in data/raw/lane-1 data/raw/lane-2    

```{sh, eval=FALSE}
wget -r -nd http://slimsdata.genomecenter.ucdavis.edu/Data/tt02drsvtz/Un_DTSA886/Project_AFSP_TUI_CHUB_RAD_L1/ .

wget -r -nd http://slimsdata.genomecenter.ucdavis.edu/Data/t44zqcghth/Un_DTSA886/Project_AFSP_TUI_CHUB_RAD_L2/ .
```


Checking checksums!!!     

We have two options, combine plates and demulti, or, demulti then combine plates. The combine first approach is by far the easiest I'd wager.

```{r}
cat lane-1/PLATE_1_S1_L006_R1_001.fastq.gz lane-2/PLATE_1_S1_L007_R1_001.fastq.gz > plate-1/plate-1-R1.fastq.gz
gunzip plate-1/plate-1-R1.fastq.gz

cat lane-1/PLATE_1_S1_L006_R2_001.fastq.gz lane-2/PLATE_1_S1_L007_R2_001.fastq.gz > plate-1/plate-1-R2.fastq.gz
gunzip plate-1/plate-1-R2.fastq.gz
```

Should automate a bash script to make subdir, cat and gunzip. Script should be able to include prefixes, so 'data/raw/combined' as a prefix should be fine with renamed samples moved to 'data/raw/split'       

```{r}
seqfiles<-read_tsv("meta/sequence-files.tsv")
seqfiles %>% mutate(Path=paste0("data/raw/",Lane,"/",File)) %>%
  group_by(Plate, Direction) %>% mutate(Files=paste0(Path, collapse = " ")) %>%
  select(Files) %>% mutate(Command=paste0("cat ", Files, " > ", "data/raw/combined/",
                                          Plate,"-",Direction,".fastq.gz;",
                                           " gunzip ", "data/raw/combined/",
                                          Plate,"-",Direction,".fastq.gz;")) %>%
  ungroup() %>% select(Command) %>% unique() %>%
  write_tsv("101.1-combine-plates.sh", col_names = FALSE)
```
Generates 30 commands, 15 plates times two directions.    
can run with module load parallel    


Demultiplexing    


Check barcode presence: grep ^GGAAACATCGTGCAGG plate-1-R1.fastq --color

in `~/fish-lake/data/raw/plate-1`     
```{sh, eval=FALSE}
ln -s ~/fish-lake/scripts/*.* .
bash 1-set-up-wellsplit.sh
sbatch 2-run-wellsplit.sh file-list.txt
```

Appears to work.     
Counting up reads from a few files 
```{sh, eval=FALSE}
for f in *RA*fastq; do echo $(cat $f|wc -l)/4|bc; done;
```
1087901    
1326113    
865321    
1059952    
1522202    
1113354    
1703102    
8374954   
601653    
1258935    
Combining all plates like so:     

```{sh, eval=FALSE}
module load parallel
srun -p high -t 10:00:00 --nodes=1 --tasks-per-node=1 --cpus-per-task=8 parallel -j 8 < 101.1-combine-plates.sh
```
Is running, will check back later.    
Myabe a problem with 14, both forward/reverse are fine.    

Symlink to split dir and running. Looks good!

in `/home/maccamp/fish-lake/data/raw/split`     
```{sh, eval=FALSE}
ln -s ~/fish-lake/scripts/*.* .
bash 1-set-up-wellsplit.sh
sbatch 2-run-wellsplit.sh file-list.txt
```
